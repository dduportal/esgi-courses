[{invert}]
= CI avec Docker

== ğŸ¤” Environnement d'exÃ©cution du CI

*ProblÃ¨me* : On souhaite avoir les mÃªmes outils dans notre CI ainsi que dans nos environnement de dÃ©veloppement

* Environnement d'exÃ©cutions diffÃ©rents :
** SystÃ¨me d'exploitation ? (macOS, Windows, Ubuntu Linux, Arch Linux, etc.)
** Architecture du processeur ? (Intel, AMD, ARM, PowerPC, Risc-V)

=> Est-ce que Docker ğŸ³ peut aider ?

== Personnaliser l'environnement GitHub Actions

Plusieurs solutions existent, chacune avec ses avantages / inconvÃ©nients :

* Personnaliser l'environnement dans votre workflow: (âš ï¸ sensible aux mises Ã  jour, âœ… facile Ã  mettre en place)
** ğŸ’¡ C'est ce qu'on Ã  fait dans nos workflows prÃ©cÃ©demment

* SpÃ©cifier un environnement prÃ©fabriquÃ© pour le workflow (âš ï¸ complexe, âœ… portable)
** C'est ce qu'on va essayer avec Docker ğŸ³

== ğŸ“ Exercice : Environnement prÃ©fabriquÃ© simple

* *But* : exÃ©cuter la commande `cat README.md | cowsay` dans le workflow avec un environnement le plus proche possible du dÃ©veloppement
** En utilisant le mÃªme environnement que GitPod (*mÃªme version de Ubuntu* et de `cowsay`)

* ğŸ‘·ğŸ½â€â™€ï¸ C'est Ã  vous de mettre Ã  jour le workflow pour exÃ©cuter les Ã©tapes dans la mÃªme image Docker que GitPod :
** ğŸ’¡ link:{gitpod_github_repo_url}/tree/main/.gitpod.yml#L5[Image utilisÃ©e dans GitPod,window="_blank"]
** ğŸ’¡ link:https://docs.github.com/en/actions/learn-github-actions/workflow-syntax-for-github-actions#jobsjob_idcontainer[Utilisation d'un container comme runner GitHub Actions,window="_blank"]
** ğŸ’¡ link:https://docs.github.com/en/actions/using-github-hosted-runners/about-github-hosted-runners#docker-container-filesystem[Contraintes d'exÃ©cution de container dans GitHub Actions (`--user=root`),window="_blank"]

== âœ… Solution : Environnement prÃ©fabriquÃ© simple

[source,yaml]
----
include::../code-samples/gh-actions/ci-docker-image.yml[tags="common,container,checkout,run-cowsay"]
----

== !

* Quel est l'impact en terme de temps d'exÃ©cution du changement prÃ©cÃ©dent ?

* *ProblÃ¨me :* Le temps entre une modification et le retour est crucial

image::wait-here.jpg[]

== ğŸ¤” ProblÃ¨me : AccÃ©lÃ©rer le workflow

* *ProblÃ¨me :*
** Optimiser prÃ©maturÃ©ment est contre-productif (commencez par faire un systÃ¨me qui marche comme prÃ©vu)
** Mais il faut bien s'y coller Ã  un moment donnÃ©

== ğŸ“ Exercice : Environnement prÃ©fabriquÃ© local

* *But :* Utiliser un `Dockerfile` pour fabriquer une image Ã  utiliser

* ğŸ¤” https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions#jobsjob_idcontainer[GitHub Actions ne permet pas de spÃ©cifier un `Dockerfile`]

* C'est Ã  vous. Mettez Ã  jour votre workflow pour :
** Fabriquer une image Docker contenant `cowsay` et basÃ©e sur le mÃªme Ubuntu que Gitpod
** https://docs.docker.com/engine/reference/builder/#copy[Copier le fichier `README`] dans l'image
** ExÃ©cuter la commande `cowsay` avec l'aide d'un conteneur avec
+
[source,bash]
----
bash -c 'README.md | cowsay'
----

== âœ… Exercice : Environnement prÃ©fabriquÃ© local

[source,Dockerfile]
----
# Dockerfile
FROM ubuntu:20.04
RUN apt-get update && apt-get install --yes cowsay
COPY ./README.md /README.md
----

[source,yaml]
----
# bonjour.yml
include::../code-samples/gh-actions/ci-docker-build.yml[]
----

== ğŸ¤” RÃ©flÃ©chissons ensemble

- Impact sur le temps ?
- Quelles limites voyez-vous ?

// == Checkpoint ğŸ¯

// => ğŸ¤” ProblÃ¨me : comment gÃ©rer les diffÃ©rences entre l'environnement d'IC et les machines de travail ?
