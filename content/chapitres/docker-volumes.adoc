[{invert}]
= Docker : Volumes

== ğŸ¤” Quel est le problÃ¨me ?

* Faut-il fabriquer sa propre image Ã  chaque fois ?
** Ref. copie du `README` pour utiliser `cowsay`

* Comment partager des fichiers entre conteneurs ?

* Et entre hÃ´te et conteneur ?

== ProblÃ¨me des Layers

* â±ï¸ Performances : les layers ont de trÃ¨s mauvais performance I/O (disque)

* ğŸ’¾ Si vous supprimez un conteneur, ses layers disparaissent

* âŒ Pas de partage de layer possible entre conteneurs

== Docker Volumes

* Ce sont des dossier stockÃ©s sur l'hÃ´te,
* gÃ©rÃ©s par le Docker Engine,
* Pouvant Ãªtre partagÃ©s,
* Et survivant aux conteneurs

=> Parfait ğŸ¦„

== ğŸ“ Votre premier volume

* VÃ©rifiez que le dossier `/app` n'existe pas au prÃ©alable :
+
[source,bash]
----
docker container run --rm alpine ls -la /app
----

* Essayez maintenant avec un volume :
+
[source,bash]
----
docker volume create app-data
docker container run --rm --volume=app-data:/app alpine ls -la /app
docker volume ls
----

* Essayez de crÃ©er un fichier dedans :
+
[source,bash]
----
docker container run --rm --volume=app-data:/app alpine touch /app/test-1
docker container run --rm --volume=app-data:/app alpine ls -la /app
----

== Partager avec l'hÃ´te

* Concept : partager un dossier/fichier de l'hÃ´te
** Contrainte : chemin absolu

* âš ï¸ Ã  n'utiliser que pour des commandes "one shot"
** Entorse Ã  la portabilitÃ© (file owner, permission, contrainte du chemin)

* ğŸ“ Dans GitPod, essayez la commande suivante :
+
[source,bash]
----
docker container run --rm --volume /workspace:/app alpine:3.17 ls -la /app
----

== ğŸ“ CI : Partager le dÃ©pÃ´t dans le conteneur

* Revenons Ã  l'image Docker dans GitHub Actions
* Enlevez la ligne `COPY README.md` du workflow
* Utilisez un partage avec l'hÃ´te pour le fichier `README.md`

* ğŸ’¡ `--workdir="$(pwd)"`

== âœ… CI : Partager le dÃ©pÃ´t dans le conteneur

[source,Dockerfile]
----
# Dockerfile
FROM ubuntu:20.04
RUN apt-get update && apt-get install --yes cowsay
----

[source,yaml]
----
# bonjour.yml
include::../code-samples/gh-actions/ci-docker-build-vol.yml[]
----

== ğŸ“ SÃ©curitÃ© des conteneurs

* *Buts :*
** Limiter l'impact d'un processus malicieux
** S'assurer des meilleurs performances de production
** Obtenir une liste exhaustive des dossier utilisÃ©s par l'application

* Essayez d'exÃ©cuter un conteneur `webserver-2`, basÃ© sur l'image `nginx`, avec l'option `--read-only` activÃ©e
** ğŸ’¡ Pensez Ã  regarder les logs si le conteneur est en erreur
** ğŸ’¡ DÃ©clarez un volume pour chaque dossier/fichier nÃ©cessitant une Ã©criture

== âœ… SÃ©curitÃ© des conteneurs

[source,bash]
----
docker container run --detach --name=webserver-2 --read-only \
  --volume=/var/cache/nginx --volume=/var/run nginx
----

== Checkpoint ğŸ¯

* Docker sÃ©pare le cycle de vie des conteneurs de celui des donnÃ©es
** Utile pour les mises Ã  jours d'images

* Les donnÃ©es des conteneurs peuvent Ãªtre partagÃ©es en utilisant des volumes

* Bonne pratique : utiliser les options de volumes de Docker permet de mieux communiquer les caractÃ©ristiques et contraintes de l'application

=> DevOps The Right Way ğŸ¦„
