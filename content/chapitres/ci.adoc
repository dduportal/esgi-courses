[{invert}]
= Int√©gration Continue (CI)

[quote, Martin Fowler]
____
Continuous Integration doesn‚Äôt get rid of bugs, but it does make them
dramatically easier to find and remove.
____

== Pourquoi la CI ?

*But :* D√©tecter les fautes au plus t√¥t pour en limiter le co√ªt

image::big-bugs.jpg[caption="Big Bugs",width=800]

[.small]
Source : http://cartoontester.blogspot.be/2010/01/big-bugs.html

== Qu'est ce que l'Int√©gration Continue ?

**Objectif :** que l'int√©gration de code soit un _non-√©v√®nement_

* Construire et int√©grer le code *en continu*
* Le code est int√©gr√© *souvent* (au moins quotidiennement)
* Chaque int√©gration est valid√©e par une ex√©cution *automatis√©e*

== Et concr√®tement ?

image::fail-fast-continuous-integration.png[height=250]

* Un‚Ä¢e d√©velopeu‚Ä¢se‚Ä¢r ajoute du code/branche/PR :
** une requ√™te HTTP est envoy√©e au syst√®me de "CI"
* Le syst√®me de CI compile et teste le code
* On ferme la boucle : Le r√©sultat est renvoy√© au d√©velopeu‚Ä¢se‚Ä¢r‚Ä¢s

== Quelques moteurs de CI connus

* A h√©berger soit-m√™me : https://www.jenkins.io/[Jenkins,window=_blank], https://about.gitlab.com/[GitLab,window=_blank], https://www.drone.io/[Drone CI,window=_blank], https://ovh.github.io/cds/[CDS,window=_blank]...
* H√©berg√©s en ligne : https://travis-ci.org/[Travis CI,window=_blank], https://semaphoreci.com/[Semaphore CI,window=_blank], https://circleci.com/[Circle CI,window=_blank], https://codefresh.io/[Codefresh,window=_blank], https://docs.github.com/en/free-pro-team@latest/actions/quickstart[GitHub Actions,window=_blank]

== GitHub Actions

GitHub Actions est un moteur de CI/CD int√©gr√© √† GitHub

* ‚úÖ : Tr√®s facile √† mettre en place, gratuit et int√©gr√© compl√®tement
* ‚ùå : Utilisable uniquement avec GitHub, et DANS la plateforme GitHub

== Anatomie de d√©clenchement de GitHub Actions

image:ghci.svg[with="800"]

== Concepts de GitHub Actions

image::gh-actions-concepts.svg[width=800]

== Concepts de GitHub Actions - Step 1/2

image::gh-actions-concepts.steps.svg[width=800]

== Concepts de GitHub Actions - Step 2/2

Une *Step* (√©tape) est une t√¢che individuelle √† faire effectuer par le CI :

* Par d√©faut c'est une commande √† ex√©cuter - mot clef `run`
* Ou une "action" (quel est le nom du produit d√©j√† ?) - mot clef `uses`
** R√©utilisables et https://docs.github.com/en/free-pro-team@latest/actions/learn-github-actions/finding-and-customizing-actions[partageables,window=_blank]

[source,yaml]
----
steps: # Liste de steps
  # Exemple de step 1 (commande)
  - name: Say Hello
    run: echo "Hello ESGI"
  # Exemple de step 2 (une action)
  - name: 'Login to DockerHub'
    uses: docker/login-action@v2 # https://github.com/marketplace/actions/docker-login
    with:
      username: ${{ secrets.DOCKERHUB_USERNAME }}
      password: ${{ secrets.DOCKERHUB_TOKEN }}
----

== Concepts de GitHub Actions - Job 1/2

image::gh-actions-concepts.jobs.svg[width=800]

== Concepts de GitHub Actions - Job 2/2

Un *Job* est un groupe logique de t√¢ches :

* Encha√Ænement _s√©quentiel_ de t√¢ches
* Regroupement logique : "qui a un sens"
** Exemple : "compiler puis tester le r√©sultat de la compilation"

[source,yaml]
----
jobs: # Map de jobs
  build: # 1er job, identifi√© comme 'build'
    name: 'Build Slides'
    runs-on: ubuntu-22.04 # cf. prochaine slide "Concepts de GitHub Actions - Runner"
    steps: # Collection de steps du job
      - name: 'Build the JAR'
        run: mvn package
      - name: 'Run Tests on the JAR file'
        run: mvn verify
  deploy: # 2nd job, identifi√© comme 'deploy'
    # ...
----

== Concepts de GitHub Actions - Runner

Un *Runner* est un serveur distant sur lequel s'ex√©cute un job.

* Mot clef `runs-on` dans la d√©finition d'un job
* D√©faut : machine virtuelle Ubuntu dans le cloud utilis√© par GitHub
* https://docs.github.com/en/free-pro-team@latest/actions/reference/specifications-for-github-hosted-runners[D'autres types sont disponibles,window=_blank]
(macOS, Windows, etc.)
* Possibilit√© de fournir https://docs.github.com/en/free-pro-team@latest/actions/reference/specifications-for-github-hosted-runners[son propre serveur,window=_blank]

== Concepts de GitHub Actions - Workflow 1/2

image::gh-actions-concepts.workflows.svg[width=800]

== Concepts de GitHub Actions - Workflow 2/2

Un *Workflow* est une proc√©dure automatis√©e compos√©e de plusieurs jobs,
d√©crite par un fichier YAML.

* On parle de "Workflow/Pipeline as Code"
* Chemin : `.github/workflows/<nom du workflow>.yml`
* On peut avoir _plusieurs_ fichiers donc _plusieurs_ workflows

[source,shell]
----
.github/workflows
‚îú‚îÄ‚îÄ ci-cd.yaml
‚îú‚îÄ‚îÄ bump-dependency.yml
‚îî‚îÄ‚îÄ nightly-tests.yaml
----

== Concepts de GitHub Actions - √âv√®nement 1/2

image::gh-actions-concepts.svg[width=800]

== Concepts de GitHub Actions - √âv√®nement 2/2

Un *√©v√®nement* du projet GitHub (push, merge, nouvelle issue, etc. ) d√©clenche l'ex√©cution du workflow

* Plein de type d'√©v√®nements : push, issue, alarme r√©guli√®re, favori, fork, etc.
** Exemple : "Nouveau commit pouss√©", "chaque dimanche √† 07:00", "une issue a √©t√© ouverte" ...

* Un workflow sp√©cifie le(s) √©v√®nement(s) qui d√©clenche(nt) son ex√©cution
** Exemple : "ex√©cuter le workflow lorsque un nouveau commit est pouss√© ou chaque jour √† 05:00 par d√©faut"

== Concepts de GitHub Actions : Exemple Complet

.Workflow File :
[source,yaml]
----
include::../code-samples/gh-actions/npm-example.yml[]
----

== Essayons GitHub Actions

* *But* : nous allons cr√©er notre premier workflow dans GitHub Actions

* N'h√©sitez pas √† utiliser la documentation de GitHub Actions:
** https://docs.github.com/en/free-pro-team@latest/actions[Accueil,window=_blank]
** https://docs.github.com/en/free-pro-team@latest/actions/quickstart[Quickstart,window=_blank]
** https://docs.github.com/en/free-pro-team@latest/actions/reference[R√©f√©rence,window=_blank]

== üéì Exercice: Cr√©ez un d√©p√¥t (git dans) GitHub

* En √©tant authentifi√© dans link:https://github.com[{github_icon} GitHub,window="_blank"],
* Cr√©ez un nouveau d√©p√¥t nomm√© `{student_gh_repository_name}`
** Pas de "template" (mod√®le)
** Visibilit√© publique
** Initialisation avec un fichier `README.md`


== üéì Exercice: R√©cup√©rez le d√©p√¥t dans Gitpod

* Obtenez l'URL (HTTPS) du d√©p√¥t GitHub fra√Æchement cr√©√©
** üí° Depuis la page  du d√©p√¥t, cliquez sur le bouton vert intitul√© "*Code*"

* Dans Gitpod,
** Depuis un terminal, positionnez-vous dans le dossier `/workspace`,
** Clonez le d√©p√¥t avec la commande `git clone https://github.com/xxx/{student_gh_repository_name}`
** üí° Si le d√©p√¥t n'appara√Æt pas dans l'"Explorer" √† gauche : `code -a /workspace/{student_gh_repository_name}`


== üéì Exercice: Exemple simple avec GitHub Actions

* Dans le d√©p√¥t `{student_gh_repository_name}`, sur la branch `main`,
** Cr√©ez le fichier `.github/workflows/bonjour.yml` avec le contenu suivant :
+
[source,yaml]
----
include::../code-samples/gh-actions/ci-base.yml[tags="common,simple-hello"]
----

* Commitez puis poussez le fichier sur GitHub:
+
[source,bash]
----
git add .github/workflows/bonjour.yml
git commit -m 'Create GitHub workflow Bonjour'
git push origin main
----

== üéì Exercice: Exemple simple avec GitHub Actions : R√©cap√©p√®te

* Revenez sur la page GitHub de votre projet et naviguez dans l'onglet "Actions" :
** Voyez-vous un workflow ? Et un Job ? Et le message affich√© par la commande `echo` ?

image::gh-actions-simple-example.svg[width=800]

== Exemple GitHub Actions : Checkout

* Supposons que l'on souhaite utiliser le code du d√©p√¥t...
** Essayez: modifiez le fichier `bonjour.yml` pour afficher le contenu de `README.md` :
+
[source,yaml]
----
include::../code-samples/gh-actions/ci-base.yml[tags="common,show-readme"]
----

* Est-ce que l'√©tape "`cat README.md`" se passe bien ? (SPOILER: non ‚ùå )

== üéì Exercice GitHub Actions : Checkout

* *But* : On souhaite r√©cup√©rer ("checkout") le code du d√©p√¥t dans le job

* üë∑üèΩ‚Äç‚ôÄÔ∏è C'est √† vous d'essayer de _r√©parer_ üõ† le job :
** L'√©tape "`cat README.md`" doit √™tre conserv√©e et doit fonctionner
** Utilisez l'action "checkout" (https://github.com/marketplace/actions/checkout[Documentation,window=_blank]) du marketplace GitHub Action
** Vous pouvez vous inspirer du https://docs.github.com/en/free-pro-team@latest/actions/quickstart[Quickstart,window=_blank] de GitHub Actions

== ‚úÖ Solution GitHub Actions : Checkout

[source,yaml]
----
include::../code-samples/gh-actions/ci-base.yml[tags="common,checkout,show-readme"]
----

== Exemple : Environnement d'ex√©cution

* Notre workflow doit s'assurer que "la vache" üêÆ doit nous lire üí¨ le contenu du fichier `README.md`
** link:https://www.destroyallsoftware.com/talks/wat[WAT ü§™, window="_blank"] ?

[%steps]
* Essayez la commande `cat README.md | cowsay` dans GitPod
** Modifiez l'√©tape "`cat README.md`" du workflow pour faire la m√™me chose dans GitHub Actions
** SPOILER: ‚ùå (la commande `cowsay` n'est pas disponible dans le runner GitHub Actions)

== üéì Exercice : Personnalisation dans le workflow

* *But* : ex√©cuter la commande `cat README.md | cowsay` dans le workflow comme dans GitPod

* üë∑üèΩ‚Äç‚ôÄÔ∏è C'est √† vous de mettre √† jour le workflow pour personnaliser l'environnement :
** üí° Cherchez comment installer `cowsay` dans le runner GitHub (`runs-on`...)

== ‚úÖ Solution : Personnalisation dans le workflow

[source,yaml]
----
include::../code-samples/gh-actions/ci-base.yml[tags="common,checkout,apt-cowsay,run-cowsay"]
----

== Checkpoint üéØ

* L'int√©gration Continue est un ensemble de pratiques pour s'assurer que le code est **continuellement** "v√©rifi√©"
* GitHub Actions est un des nombreux syst√®mes permettant de faire de l'int√©gration continue


=> ü§î Probl√®me : comment g√©rer les diff√©rences entre l'environnement d'IC et les machines de travail ?
