= CI avec Docker Images

== Personnaliser l'environnement GitHub Actions

Plusieurs solutions existent, chacune avec ses avantages / inconvÃ©nients :

* Personnaliser l'environnement dans votre workflow: (âš ï¸ sensible aux mises Ã  jour, âœ… facile Ã  mettre en place)
** ğŸ’¡ C'est ce qu'on Ã  fait dans nos workflows prÃ©cÃ©demment

* SpÃ©cifier un environnement prÃ©fabriquÃ© pour le workflow (âš ï¸ complexe, âœ… portable)
** C'est ce qu'on va essayer avec Docker ğŸ³

== ğŸ“ Exercice : Environnement prÃ©fabriquÃ© simple

* *But* : exÃ©cuter le workflow dans un environnement le plus proche possible du dÃ©veloppement
** En utilisant le mÃªme environnement que GitPod (*mÃªme version* de `node` et `npm`)

* ğŸ‘·ğŸ½â€â™€ï¸ C'est Ã  vous de mettre Ã  jour le workflow pour exÃ©cuter les Ã©tapes dans la mÃªme image Docker que GitPod :
** ğŸ’¡ link:{gitpod_github_repo_url}/tree/main/.gitpod.yml#L5[Image utilisÃ©e dans GitPod,window="_blank"]
** ğŸ’¡ link:https://docs.github.com/en/actions/learn-github-actions/workflow-syntax-for-github-actions#jobsjob_idcontainer[Utilisation d'un container comme runner GitHub Actions,window="_blank"]
** ğŸ’¡ link:https://docs.github.com/en/actions/using-github-hosted-runners/about-github-hosted-runners#docker-container-filesystem[Contraintes d'exÃ©cution de container dans GitHub Actions (`--user=root`),window="_blank"]

== âœ… Solution : Environnement prÃ©fabriquÃ© simple

[source,yaml]
----
include::../code-samples/gh-actions/ci-nodejs.yml[tags="common,initial,container"]
----

== !

* Quel est l'impact en terme de temps d'exÃ©cution du changement prÃ©cÃ©dent ?

* *ProblÃ¨me :* Le temps entre une modification et le retour est crucial

image::wait-here.jpg[]

== ğŸ“ Exercice : Environnement prÃ©fabriquÃ© local

* *But :* Utiliser un `Dockerfile` pour fabriquer une image Ã  utiliser

* ğŸ¤” https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions#jobsjob_idcontainer[GitHub Actions ne permet pas de spÃ©cifier un `Dockerfile`]

* C'est Ã  vous. Mettez Ã  jour votre workflow pour :
** Fabriquer une image Docker contenant `npm` et `node`, mÃªme versions que dans GitPod et qui installe les dÃ©pendances
*** ğŸ’¡ Pensez Ã  copier le code source !

** ExÃ©cuter la commande `npm run lint` dans un conteneur basÃ© sur cette image

== âœ… Exercice : Environnement prÃ©fabriquÃ© local

[source,Dockerfile]
----
# Dockerfile
FROM node:19
WORKDIR /app
COPY ./package.json /app/
COPY ./package-lock.json /app/
RUN npm ci
COPY ./index.js /app/
----

[source,yaml]
----
# bonjour.yml
include::../code-samples/gh-actions/ci-nodejs-docker.yml[]
----

== ğŸ¤” RÃ©flÃ©chissons ensemble

- Impact sur le temps de build ?
- Quelles limites voyez-vous ?

== Checkpoint ğŸ¯

- On peut exÃ©cuter des tÃ¢ches de CI dans des images de container
- Un curseur est Ã  positionner entre des images prÃ©fabriquÃ©es qui peuvent Ãªtre lourdes ou fabriquer soit-mÃªme sa propre image
